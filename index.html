<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Hubbe Pro: Lockdown Build v2.8</title>
<style>
:root { 
    --olive: #606C38; --dark: #283618; --cream: #FEFAE0; --rust: #BC6C25; 
    --white: #ffffff; --blue: #2b6a94; --green: #2d6a4f; --red: #ae2012; 
    --purple: #5a189a; --gold: #daa520; --gray: #f4f4f4;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body { margin: 0; height: 100dvh; display: flex; flex-direction: column; background: var(--cream); overflow: hidden; padding-top: env(safe-area-inset-top); color: #333; }

header { background: var(--white); padding: 12px; border-bottom: 1px solid #ddd; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.header-top { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
.logo { width: 38px; height: 38px; background: var(--olive); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.4rem; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
.room-controls { flex: 1; display: flex; align-items: center; gap: 6px; }
.room-selector { flex: 1; padding: 10px; border-radius: 12px; border: 2px solid var(--olive); font-weight: bold; background: #fff; font-size: 0.9rem; outline: none; }
.room-btn { background: var(--gray); border: 1px solid #ddd; border-radius: 10px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; transition: 0.2s; }
.room-btn:active { transform: scale(0.9); background: #e0e0e0; }

.nav-bar { display: flex; background: var(--gray); padding: 4px; border-radius: 14px; gap: 4px; }
.nav-tab { flex: 1; border: none; padding: 12px 5px; border-radius: 10px; font-weight: 800; color: #888; background: none; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.5px; transition: 0.3s; }
.nav-tab.active { background: white; color: var(--olive); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

#canvas-container { height: 42vh; background: #222; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; touch-action: none; flex-shrink: 0; }
#garden-img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; z-index: 100; opacity: 0.9; }
#grid-svg { position: absolute; inset: 0; pointer-events: none; z-index: 600; width: 100%; height: 100%; display: none; }
#grid-svg.active { display: block; }

.spot { position: absolute; z-index: 500; pointer-events: auto; transition: opacity 0.3s; }
.spot-label { background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); color: white; padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 0.65rem; white-space: nowrap; pointer-events: none; z-index: 700; position: absolute; transform: translate(-50%, -50%); border: 1px solid rgba(255,255,255,0.2); }

.view { flex: 1; display: none; overflow-y: auto; padding-bottom: 40px; -webkit-overflow-scrolling: touch; }
.view.active { display: flex; flex-direction: column; }

.care-toolbar { display: flex; gap: 8px; padding: 10px 15px; background: var(--white); border-bottom: 1px solid #eee; }
.care-btn { flex: 1; border: none; border-radius: 14px; padding: 12px; color: white; font-weight: bold; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

.overlay-btn { background: rgba(255, 255, 255, 0.95); color: #333; border: none; padding: 8px 16px; border-radius: 16px; font-weight: 800; font-size: 0.75rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
.overlay-btn:active { transform: scale(0.95); background: #eee; }

.item-card { background: white; padding: 12px; border-radius: 18px; margin: 8px 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #eee; box-shadow: 0 3px 8px rgba(0,0,0,0.04); transition: 0.2s; }
.item-card:active { transform: scale(0.98); background: #f9f9f9; }
.card-thumb { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #eee; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 15px; backdrop-filter: blur(5px); }
.modal-content { background: white; width: 100%; max-width: 420px; padding: 25px; border-radius: 28px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }

.btn-compact { padding: 14px; border: none; border-radius: 16px; font-weight: 800; width: 100%; margin-top: 10px; font-size: 0.9rem; cursor: pointer; transition: 0.2s; }
.btn-compact:active { opacity: 0.8; transform: translateY(1px); }
.field-label { font-size: 0.7rem; font-weight: 800; color: var(--olive); margin-top: 15px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
.h-input { width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #eee; margin-top: 6px; font-size: 1rem; outline: none; transition: 0.3s; }
.h-input:focus { border-color: var(--olive); }

.anchor { position:absolute; width:44px; height:44px; background:var(--red); border:4px solid white; border-radius:50%; transform:translate(-50%,-50%); z-index: 3000; display:none; touch-action: none; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
#cal-done-float { position:absolute; bottom:30px; right:20px; z-index:4000; background:var(--green); color:white; border:4px solid white; border-radius:50%; width:64px; height:64px; font-size:1.8rem; display:none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

.timeline-wrap { display: flex; gap: 12px; overflow-x: auto; padding: 10px 0; margin-top: 5px; scroll-snap-type: x mandatory; }
.timeline-item { position: relative; flex-shrink: 0; width: 70px; text-align: center; scroll-snap-align: start; }
.timeline-thumb { width: 70px; height: 70px; border-radius: 14px; object-fit: cover; border: 2px solid #eee; }
.timeline-date { font-size: 0.55rem; color: #999; display: block; margin-top: 4px; font-weight: bold; }
.t-del { position: absolute; top: -5px; right: -5px; background: var(--red); color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; z-index: 5; }

.color-row { display: flex; justify-content: space-between; margin: 10px 0; gap: 10px; }
.color-dot { width: 44px; height: 44px; border-radius: 50%; border: 3px solid #eee; cursor: pointer; transition: 0.2s; }
.color-dot.active { border-color: #333 !important; transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

.req-row { display: flex; gap: 10px; margin-top: 6px; }
.req-btn { flex: 1; border: 2px solid #eee; background: white; border-radius: 12px; padding: 8px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
.req-btn span { font-size: 0.6rem; font-weight: 800; color: #888; text-transform: uppercase; }
.req-btn.active { border-color: var(--olive); background: var(--cream); }
.req-btn.active[data-type="sun"] { border-color: var(--gold); background: #fffdf0; }
.req-btn.active[data-type="water"] { border-color: var(--blue); background: #f0f7ff; }

.card-meta { display: flex; gap: 8px; margin-top: 4px; align-items: center; }
.badge { font-size: 0.6rem; font-weight: 800; padding: 2px 6px; border-radius: 6px; display: flex; align-items: center; gap: 3px; }
.badge-sun { background: #fffdf0; color: #b08d00; border: 1px solid #ffeaa7; }
.badge-water { background: #f0f7ff; color: #2b6a94; border: 1px solid #d1e9ff; }
</style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="logo">H</div>
        <div class="room-controls">
            <select id="roomSelector" class="room-selector" onchange="roomSwitch(this.value)"></select>
            <button class="room-btn" onclick="renameRoom()">‚úèÔ∏è</button>
            <button class="room-btn" onclick="deleteRoom()" style="color:var(--red);">üóëÔ∏è</button>
        </div>
        <button class="room-btn" onclick="openMod('settingsModal')">‚öôÔ∏è</button>
    </div>
    <div class="nav-bar">
        <button id="nav-garden" class="nav-tab active" onclick="showV('garden')">GARDEN</button>
        <button id="nav-library" class="nav-tab" onclick="showV('library')">LIBRARY</button>
        <button id="nav-harvest" class="nav-tab" onclick="showV('harvest')">HARVEST</button>
    </div>
</header>

<div id="view-garden" class="view active">
    <div class="care-toolbar">
        <button class="care-btn" style="background:var(--blue);" onclick="roomCare('Watered')">üíß WATER</button>
        <button class="care-btn" style="background:var(--purple);" onclick="roomCare('Fertilized')">üß™ FERT</button>
        <button class="care-btn" style="background:var(--rust);" onclick="openMod('helpModal')">‚ùì HELP</button>
    </div>
    <div id="canvas-container" onclick="handleGridClick(event)">
        <img id="garden-img" src="" style="display:none;">
        
        <div class="setup-toolbar" style="position: absolute; bottom: 12px; left: 12px; display: flex; gap: 10px; z-index:900;">
            <button class="overlay-btn" onclick="document.getElementById('bgIn').click()">üì∑ PHOTO</button>
            <button class="overlay-btn" onclick="togGrid()"># GRID</button>
            <button class="overlay-btn" onclick="startLightMeter()">‚òÄÔ∏è METER</button>
        </div>

        <input type="file" id="bgIn" hidden accept="image/*" onchange="handleFile(this, 'room')">
        <svg id="grid-svg"></svg>
        <div id="anchor-tl" class="anchor" data-id="tl"></div>
        <div id="anchor-tr" class="anchor" data-id="tr"></div>
        <div id="anchor-bl" class="anchor" data-id="bl"></div>
        <div id="anchor-br" class="anchor" data-id="br"></div>
        <button id="cal-done-float" onclick="stopCal()">‚úì</button>
    </div>
    <div id="garden-card-list"></div>
</div>

<div id="view-library" class="view">
    <div style="padding:15px;"><button class="btn-compact" style="background:var(--green); color:white;" onclick="openPMod(null)">+ ADD NEW PLANT</button></div>
    <div id="p-list"></div>
</div>

<div id="view-harvest" class="view">
    <div style="padding:15px;"><button class="btn-compact" style="background:var(--gold); color:white;" onclick="openHMod(null)">+ LOG NEW HARVEST</button></div>
    <div id="h-list"></div>
</div>

<div id="lightModal" class="modal" onclick="checkClose(event, 'lightModal')"><div class="modal-content" style="text-align: center;">
    <h3 style="margin-top:0; color:var(--olive);">Light Meter</h3>
    <p style="font-size:0.8rem; color:#666;">Point your camera at the grid cell.</p>
    <div style="position:relative; width:100%; height:250px; background:#000; border-radius:18px; overflow:hidden; margin-bottom:15px;">
        <video id="cameraFeed" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
    </div>
    <h1 id="lightScore" style="margin:10px 0; color:var(--gold);">Calculating...</h1>
    <p id="lightDesc" style="font-size:0.9rem; font-weight:bold; color:#555;">...</p>
    <canvas id="lightCanvas" style="display:none;"></canvas>
    <button class="btn-compact" style="background:#eee; color:#333;" onclick="stopLightMeter()">CLOSE METER</button>
</div></div>

<div id="pModal" class="modal" onclick="checkClose(event, 'pModal')"><div class="modal-content">
    <div id="pPrev" style="width:100%;height:160px;background:#f8f8f8;border-radius:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:2px dashed #ddd;" onclick="previewCover()">No Photo</div>
    <button class="btn-compact" style="background:var(--blue); color:white;" onclick="document.getElementById('pIn').click()">CHANGE COVER</button>
    <input type="file" id="pIn" hidden accept="image/*" onchange="handleFile(this, 'plant')">
    
    <label class="field-label">NAME</label><input type="text" id="pName" class="h-input" placeholder="e.g. Tomato Row 1">
    <label class="field-label">DATE PLANTED</label><input type="date" id="pDatePlanted" class="h-input">
    
    <label class="field-label">SUN NEED</label>
    <div class="req-row">
        <button class="req-btn" data-type="sun" data-val="low" onclick="setReq('sun', 'low')">‚òÅÔ∏è<span>Low</span></button>
        <button class="req-btn" data-type="sun" data-val="med" onclick="setReq('sun', 'med')">‚õÖ<span>Part</span></button>
        <button class="req-btn" data-type="sun" data-val="high" onclick="setReq('sun', 'high')">‚òÄÔ∏è<span>Full</span></button>
    </div>

    <label class="field-label">WATER NEED</label>
    <div class="req-row">
        <button class="req-btn" data-type="water" data-val="low" onclick="setReq('water', 'low')">üåµ<span>Rare</span></button>
        <button class="req-btn" data-type="water" data-val="med" onclick="setReq('water', 'med')">üíß<span>Weekly</span></button>
        <button class="req-btn" data-type="water" data-val="high" onclick="setReq('water', 'high')">üåä<span>Daily</span></button>
    </div>

    <label class="field-label">CARE LOG / HISTORY</label><textarea id="pNotes" class="h-input" style="height:100px; resize:none;"></textarea>
    
    <label class="field-label">COLOR & OPACITY</label>
    <div class="color-row">
        <div class="color-dot" data-rgb="45, 106, 79" style="background:rgba(45, 106, 79, 0.7);" onclick="setPlantColor(this)"></div>
        <div class="color-dot" data-rgb="43, 106, 148" style="background:rgba(43, 106, 148, 0.7);" onclick="setPlantColor(this)"></div>
        <div class="color-dot" data-rgb="188, 108, 37" style="background:rgba(188, 108, 37, 0.7);" onclick="setPlantColor(this)"></div>
        <div class="color-dot" data-rgb="174, 32, 18" style="background:rgba(174, 32, 18, 0.7);" onclick="setPlantColor(this)"></div>
    </div>
    
    <div style="display:flex; align-items:center; gap:10px; margin-top:5px; margin-bottom: 15px;">
        <span style="font-size:0.65rem; font-weight:800; color:#888;">FAINT</span>
        <input type="range" id="pOpacity" min="0.1" max="1" step="0.05" style="flex:1; accent-color: var(--olive);" oninput="updateOpacity(this.value)">
        <span style="font-size:0.65rem; font-weight:800; color:#888;">SOLID</span>
    </div>

    <label class="field-label">PROGRESS PHOTOS</label>
    <div id="timeline-list" class="timeline-wrap"></div>
    <button class="btn-compact" style="background:#eee; color:#333; font-size:0.75rem;" onclick="document.getElementById('progIn').click()">+ ADD PHOTO</button>
    <input type="file" id="progIn" hidden accept="image/*" onchange="addTimelinePhoto(this)">

    <div id="garden-actions-wrap" style="display:none; margin-top:10px;"><button class="btn-compact" style="background:var(--rust); color:white;" onclick="removeFromGarden()">REMOVE FROM ROOM</button></div>
    <div id="flow-btn-wrap" style="display:none;"><button class="btn-compact" style="background:var(--blue); color:white;" onclick="enterFlow()">‚ú® PLACE IN GARDEN</button></div>
    
    <button class="btn-compact" style="background:var(--green); color:white;" onclick="saveP()">SAVE ALL</button>
    <button id="pDelBtn" class="btn-compact" style="background:none; color:var(--red); border:2px solid var(--red); display:none;" onclick="deletePlant()">DELETE PLANT</button>
    <button class="btn-compact" style="background:#eee;color:#333;" onclick="closeMod('pModal')">BACK</button>
</div></div>

<div id="hModal" class="modal" onclick="checkClose(event, 'hModal')"><div class="modal-content">
    <h3 style="margin-top:0">Log Harvest</h3>
    <div id="hPrev" style="width:100%;height:150px;background:#f0f0f0;border-radius:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;border:2px dashed #ccc;" onclick="document.getElementById('hIn').click()">Photo</div>
    <input type="file" id="hIn" hidden accept="image/*" onchange="handleHFile(this)">
    <label class="field-label">DATE</label><input type="date" id="hDate" class="h-input">
    <label class="field-label">PLANT</label><select id="hPlantSel" class="h-input"></select>
    <label class="field-label">AMOUNT</label><input type="text" id="hAmount" class="h-input" placeholder="e.g. 500g, 2 baskets">
    <label class="field-label">SATISFACTION</label>
    <div class="star-row" style="display:flex; gap:10px; justify-content:center; margin:10px 0;">
        <span class="star" data-v="1" onclick="setStar(1)" style="font-size:2rem; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span class="star" data-v="2" onclick="setStar(2)" style="font-size:2rem; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span class="star" data-v="3" onclick="setStar(3)" style="font-size:2rem; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span class="star" data-v="4" onclick="setStar(4)" style="font-size:2rem; cursor:pointer; color:#ddd;">‚òÖ</span>
        <span class="star" data-v="5" onclick="setStar(5)" style="font-size:2rem; cursor:pointer; color:#ddd;">‚òÖ</span>
    </div>
    <button class="btn-compact" style="background:var(--green); color:white;" onclick="saveHarvest()">SAVE</button>
    <button id="hDelBtn" class="btn-compact" style="background:none; color:var(--red); border:2px solid var(--red); display:none;" onclick="deleteHarvest()">DELETE</button>
    <button class="btn-compact" style="background:#eee;color:#333;" onclick="closeMod('hModal')">CANCEL</button>
</div></div>

<div id="helpModal" class="modal" onclick="checkClose(event, 'helpModal')"><div class="modal-content">
    <h2 style="margin-top:0; color:var(--olive);">Guide</h2>
    <p>1. Tap PHOTO to add room background.</p>
    <p>2. Tap SETUP to align your grid.</p>
    <p>3. Add plants in LIBRARY.</p>
    <p>4. Tap PLACE IN GARDEN to pin to the room.</p>
    <p>5. Log yields in the HARVEST tab.</p>
    <p>6. Use ‚òÄÔ∏è METER to scan for light levels.</p>
    <button class="btn-compact" style="background:var(--olive); color:white;" onclick="closeMod('helpModal')">GOT IT!</button>
</div></div>

<div id="settingsModal" class="modal" onclick="checkClose(event, 'settingsModal')"><div class="modal-content">
    <h3>Setup Space</h3>
    <label class="field-label">Depth (Number of Rows)</label><input type="number" id="gRows" class="h-input">
    <label class="field-label">Width (Number of Columns)</label><input type="number" id="gCols" class="h-input">
    <button class="btn-compact" style="background:var(--blue); color:white;" onclick="applyGridChanges()">SAVE SIZE</button>
    <button class="btn-compact" style="background:var(--rust); color:white;" onclick="startCal()">CALIBRATE CORNERS</button>
    
    <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
    
    <label class="field-label" id="backupStatus">Last backup: Not saved</label>
    <button class="btn-compact" style="background:var(--olive); color:white;" onclick="exportData()">üì§ BACKUP DATA</button>
    <button class="btn-compact" style="background:var(--dark); color:white;" onclick="document.getElementById('restoreIn').click()">üì• RESTORE DATA</button>
    <input type="file" id="restoreIn" hidden accept=".json" onchange="importData(this)">

    <button class="btn-compact" style="background:#eee; color:#333; margin-top:20px;" onclick="closeMod('settingsModal')">CLOSE</button>
</div></div>

<div id="fullImgMod" class="modal" onclick="closeMod('fullImgMod')"><img id="fullImgSrc" src="" style="max-width:95%; max-height:90%; border:2px solid white; border-radius:10px; box-shadow: 0 0 30px rgba(0,0,0,0.5);"></div>

<script>
let db, state = { areas: [{id:1, name:"Garden 1", img:null, spots:[], grid: {active:false, rows:4, cols:3, tl:{x:10,y:10}, tr:{x:90,y:10}, bl:{x:10,y:90}, br:{x:90,y:90}}}], plants: [], harvests: [], activeIdx: 0, lastBackup: "Not saved" };
let currentPlantID = null, currentHarvestID = null, flowActive = false, calActive = false, pendingPImg = null, pendingHImg = null, selHRating = 0, currentTimeline = [];
let curSun = 'med', curWater = 'med';

let selectedColor = "rgba(45, 106, 79, 0.7)", selectedRGB = "45, 106, 79", selectedAlpha = 0.7;

// --- NEW LIGHT METER VARIABLES ---
let cameraStream = null;
let lightLoopId = null;

const dbReq = indexedDB.open("HubbePlantDB_LOCKDOWN_V2", 1);
dbReq.onupgradeneeded = e => { db = e.target.result; db.createObjectStore("data"); };
dbReq.onsuccess = e => { db = e.target.result; load(); };

function getISODate() { return new Date().toISOString().split('T')[0]; }
function load() { const tx = db.transaction("data", "readonly"); const r = tx.objectStore("data").get("state"); r.onsuccess = () => { if (r.result) state = r.result; render(); }; }
function save() { const tx = db.transaction("data", "readwrite"); tx.objectStore("data").put(state, "state"); render(); }

const lerp = (a, b, t) => ({ x: a.x + (b.x - a.x) * t, y: a.y + (b.y - a.y) * t });
const getGridPoint = (grid, u, v) => lerp(lerp(grid.tl, grid.tr, u), lerp(grid.bl, grid.br, u), v);

function checkClose(e, id) { if(e.target.id === id) closeMod(id); }

function setReq(type, val) {
    if(type === 'sun') curSun = val;
    if(type === 'water') curWater = val;
    document.querySelectorAll(`.req-btn[data-type="${type}"]`).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.val === val);
    });
}

function render() {
    const area = state.areas[state.activeIdx];
    const container = document.getElementById('canvas-container');
    const img = document.getElementById('garden-img');
    const svg = document.getElementById('grid-svg');
    container.querySelectorAll('.spot').forEach(s => s.remove()); 
    svg.replaceChildren(); 
    document.getElementById('roomSelector').innerHTML = state.areas.map((a, i) => `<option value="${i}" ${i==state.activeIdx?'selected':''}>${a.name}</option>`).join('') + '<option value="ADD">+ NEW ROOM</option>';
    if (area.img) {
        img.src = area.img; img.style.display = "block";
        const doDraw = () => {
            if(!state.areas[state.activeIdx] || state.areas[state.activeIdx].id !== area.id) return;
            const r = img.getBoundingClientRect(), c = container.getBoundingClientRect();
            const offX = r.left - c.left, offY = r.top - c.top;
            const proj = (p) => ({ x: offX + (p.x/100)*r.width, y: offY + (p.y/100)*r.height });
            area.spots.forEach(s => {
                const p = state.plants.find(x => x.id === s.pId); if(!p) return;
                const u1 = s.c/area.grid.cols, u2 = (s.c+1)/area.grid.cols, v1 = s.r/area.grid.rows, v2 = (s.r+1)/area.grid.rows;
                const pts = [getGridPoint(area.grid,u1,v1), getGridPoint(area.grid,u2,v1), getGridPoint(area.grid,u2,v2), getGridPoint(area.grid,u1,v2)].map(proj);
                const d = document.createElement('div'); d.className = 'spot';
                d.style.left = '0px'; d.style.top = '0px'; d.style.width = c.width+'px'; d.style.height = c.height+'px';
                d.style.background = p.color || "rgba(45, 106, 79, 0.7)"; 
                d.style.clipPath = `polygon(${pts[0].x}px ${pts[0].y}px, ${pts[1].x}px ${pts[1].y}px, ${pts[2].x}px ${pts[2].y}px, ${pts[3].x}px ${pts[3].y}px)`;
                const lbl = document.createElement('span'); lbl.className = 'spot-label'; 
                lbl.style.left = `${(pts[0].x+pts[2].x)/2}px`; lbl.style.top = `${(pts[0].y+pts[2].y)/2}px`; 
                lbl.textContent = p.name;
                d.onclick = (e) => { e.stopPropagation(); openPMod(p.id); }; 
                d.appendChild(lbl); container.appendChild(d);
            });
            drawGrid(proj, area);
        };
        if(img.complete) doDraw(); else img.onload = doDraw;
    } else { img.src = ""; img.style.display = 'none'; svg.classList.remove('active'); }
    renderLists(area);
}

function renderLists(area) {
    const getIcon = (type, val) => {
        const icons = { sun: { low: '‚òÅÔ∏è', med: '‚õÖ', high: '‚òÄÔ∏è' }, water: { low: 'üåµ', med: 'üíß', high: 'üåä' } };
        return icons[type][val] || icons[type]['med'];
    };
    const getBadges = (p) => `<div class="card-meta"><span class="badge badge-sun">${getIcon('sun', p.sun)} ${p.sun?.toUpperCase() || 'MED'}</span><span class="badge badge-water">${getIcon('water', p.water)} ${p.water?.toUpperCase() || 'MED'}</span></div>`;
    document.getElementById('garden-card-list').innerHTML = [...new Set(area.spots.map(s => s.pId))].map(pid => {
        const p = state.plants.find(x => x.id === pid); const s = area.spots.find(x => x.pId === pid);
        return `<div class="item-card" onclick="openPMod(${p.id})"><img src="${p.img || ''}" class="card-thumb"><div style="flex:1;"><b>${p.name}</b><br><small>Position: D${s.r+1} W${s.c+1} | üå± ${p.datePlanted || 'No date'}</small>${getBadges(p)}</div></div>`;
    }).join('');
    document.getElementById('p-list').innerHTML = state.plants.map(p => {
        let loc = "Not Planted"; state.areas.forEach(a => { if(a.spots.some(s => s.pId === p.id)) loc = a.name; });
        return `<div class="item-card" onclick="openPMod(${p.id})"><img src="${p.img || ''}" class="card-thumb"><div style="flex:1;"><b>${p.name}</b><br><small>üìç ${loc} | üå± ${p.datePlanted || 'No date'}</small>${getBadges(p)}</div></div>`;
    }).join('');
    document.getElementById('h-list').innerHTML = state.harvests.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(h => `<div class="item-card" onclick="openHMod(${h.id})"><img src="${h.img || ''}" class="card-thumb"><div style="flex:1;"><b>${h.plantName}</b><br><small>${h.date} | ${h.amount}</small><br><span style="color:var(--gold)">${'‚òÖ'.repeat(h.rating)}</span></div></div>`).join('');
}

function roomCare(type) { if(!confirm(`Mark all in ${state.areas[state.activeIdx].name} as ${type}?`)) return; state.areas[state.activeIdx].spots.forEach(s => { const p = state.plants.find(x => x.id === s.pId); if(p) p.notes += `\n[${getISODate()}] ${type}`; }); save(); }
function setStar(v) { selHRating = v; document.querySelectorAll('.star').forEach(s => s.style.color = parseInt(s.dataset.v) <= v ? 'var(--gold)' : '#ddd'); }

function openHMod(id = null) { 
    currentHarvestID = id; const h = id ? state.harvests.find(x => x.id === id) : null; 
    document.getElementById('hDate').value = h ? h.date : getISODate(); 
    document.getElementById('hAmount').value = h ? h.amount : ""; 
    document.getElementById('hPlantSel').innerHTML = state.plants.map(p => `<option value="${p.id}" ${h && h.plantId == p.id ? 'selected' : ''}>${p.name}</option>`).join(''); 
    pendingHImg = h ? h.img : null; 
    document.getElementById('hPrev').innerHTML = pendingHImg ? `<img src="${pendingHImg}" style="width:100%;height:100%;object-fit:cover;">` : "Photo"; 
    setStar(h ? h.rating : 0); 
    document.getElementById('hDelBtn').style.display = h ? "block" : "none"; 
    openMod('hModal'); 
}

function saveHarvest() {
    const pId = parseInt(document.getElementById('hPlantSel').value); const p = state.plants.find(x => x.id === pId);
    if(!pId) return alert("Select a plant first!");
    const data = { id: currentHarvestID || Date.now(), plantId: pId, plantName: p ? p.name : "?", date: document.getElementById('hDate').value, amount: document.getElementById('hAmount').value, rating: selHRating, img: pendingHImg };
    if(currentHarvestID) { let idx = state.harvests.findIndex(x => x.id === currentHarvestID); state.harvests[idx] = data; }
    else { state.harvests.push(data); if(p) p.notes += `\n[${data.date}] Harvested ${data.amount}`; }
    closeMod('hModal'); save();
}

function openPMod(id = null) {
    currentPlantID = id; const p = id ? state.plants.find(x => x.id === id) : null; 
    currentTimeline = p && p.timeline ? [...p.timeline] : [];
    document.getElementById('pName').value = p ? p.name : ""; 
    document.getElementById('pDatePlanted').value = p && p.datePlanted ? p.datePlanted : getISODate();
    document.getElementById('pNotes').value = p ? (p.notes || "") : "";
    document.getElementById('pPrev').innerHTML = p && p.img ? `<img id="mainPImg" src="${p.img}" style="width:100%;height:100%;object-fit:cover;">` : "No Photo";
    pendingPImg = p ? p.img : null;
    curSun = p && p.sun ? p.sun : 'med'; curWater = p && p.water ? p.water : 'med';
    setReq('sun', curSun); setReq('water', curWater);
    selectedColor = p ? (p.color || "rgba(45, 106, 79, 0.7)") : "rgba(45, 106, 79, 0.7)";
    let match = selectedColor.match(/rgba\((.*?),\s*([\d.]+)\)/);
    if(match) { selectedRGB = match[1]; selectedAlpha = parseFloat(match[2]); }
    document.getElementById('pOpacity').value = selectedAlpha;
    document.querySelectorAll('.color-dot').forEach(d => {
        let dotRGB = d.dataset.rgb.replace(/\s/g, ''); let selRGB = selectedRGB.replace(/\s/g, '');
        d.classList.toggle('active', dotRGB === selRGB); d.style.background = `rgba(${d.dataset.rgb}, ${selectedAlpha})`; 
    });
    const isIn = state.areas.some(a => a.spots.some(s => s.pId === id));
    document.getElementById('garden-actions-wrap').style.display = (id && isIn) ? "block" : "none";
    document.getElementById('flow-btn-wrap').style.display = (p && !isIn) ? "block" : "none";
    document.getElementById('pDelBtn').style.display = id ? "block" : "none";
    renderTimeline(); openMod('pModal');
}

function saveP() {
    const name = document.getElementById('pName').value;
    if(!name) return alert("Please enter a name");
    const p = { 
        id: currentPlantID || Date.now(), 
        name, 
        notes: document.getElementById('pNotes').value, 
        img: pendingPImg || "", 
        timeline: currentTimeline, 
        color: selectedColor, 
        sun: curSun, 
        water: curWater,
        datePlanted: document.getElementById('pDatePlanted').value
    };
    if(currentPlantID) { let idx = state.plants.findIndex(x => x.id === currentPlantID); state.plants[idx] = p; } else state.plants.push(p);
    closeMod('pModal'); save();
}

function deletePlant() {
    if(confirm("Permanently delete this plant? This cannot be undone.")) {
        state.plants = state.plants.filter(x => x.id !== currentPlantID);
        state.areas.forEach(a => { a.spots = a.spots.filter(s => s.pId !== currentPlantID); });
        closeMod('pModal'); save();
    }
}

function setPlantColor(el) { selectedRGB = el.dataset.rgb; selectedColor = `rgba(${selectedRGB}, ${selectedAlpha})`; document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('active', d === el)); }
function updateOpacity(val) { selectedAlpha = val; selectedColor = `rgba(${selectedRGB}, ${selectedAlpha})`; document.querySelectorAll('.color-dot').forEach(d => d.style.background = `rgba(${d.dataset.rgb}, ${selectedAlpha})`); }
function renderTimeline() { document.getElementById('timeline-list').innerHTML = currentTimeline.map((item, idx) => `<div class="timeline-item"><img src="${item.img}" class="timeline-thumb" onclick="previewImg('${item.img}')"><span class="timeline-date">${item.date}</span><div class="t-del" onclick="deleteTimelineItem(${idx})">‚úï</div></div>`).join(''); }
function addTimelinePhoto(input) { if(!input.files[0]) return; resize(input.files[0], 1200).then(data => { currentTimeline.push({ img: data, date: getISODate() }); renderTimeline(); }); }
function deleteTimelineItem(idx) { if(confirm("Delete photo?")) { currentTimeline.splice(idx, 1); renderTimeline(); } }

function handleGridClick(e) { 
    if (!flowActive || !currentPlantID || calActive) return; 
    const r = document.getElementById('garden-img').getBoundingClientRect(), area = state.areas[state.activeIdx];
    const tx = ((e.clientX - r.left) / r.width) * 100, ty = ((e.clientY - r.top) / r.height) * 100; 
    let bestRow = -1, bestCol = -1, minDist = Infinity; 
    for (let row = 0; row < area.grid.rows; row++) { for (let col = 0; col < area.grid.cols; col++) { 
        const center = getGridPoint(area.grid, (col + 0.5)/area.grid.cols, (row + 0.5)/area.grid.rows); const d = Math.hypot(center.x - tx, center.y - ty); if (d < minDist) { minDist = d; bestRow = row; bestCol = col; } 
    } } 
    if (bestRow !== -1 && minDist < 25) { 
        const p = state.plants.find(x => x.id === currentPlantID); 
        if(p) p.notes += `\n[${getISODate()}] Planted in: ${area.name} (D:${bestRow+1} W:${bestCol+1})`;
        area.spots = area.spots.filter(s => s.r !== bestRow || s.c !== bestCol); 
        area.spots.push({ pId: currentPlantID, r: bestRow, c: bestCol }); 
        flowActive = false; save(); 
    } 
}

function drawGrid(proj, area) {
    const svg = document.getElementById('grid-svg'); svg.replaceChildren(); 
    if (area.grid.active || calActive) {
        svg.classList.add('active'); let pth = "";
        for (let r = 0; r <= area.grid.rows; r++) { let p1 = proj(getGridPoint(area.grid, 0, r/area.grid.rows)), p2 = proj(getGridPoint(area.grid, 1, r/area.grid.rows)); pth += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="white" stroke-width="1.5" stroke-dasharray="4" />`; }
        for (let c = 0; c <= area.grid.cols; c++) { let p1 = proj(getGridPoint(area.grid, c/area.grid.cols, 0)), p2 = proj(getGridPoint(area.grid, c/area.grid.cols, 1)); pth += `<line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="white" stroke-width="1.5" stroke-dasharray="4" />`; }
        svg.innerHTML = pth;
        document.querySelectorAll('.anchor').forEach(el => { el.style.display = calActive ? 'block' : 'none'; if(calActive) { let p = proj(area.grid[el.dataset.id]); el.style.left = p.x+'px'; el.style.top = p.y+'px'; } });
    } else svg.classList.remove('active');
}

function handleFile(input, type) { 
    const reader = new FileReader(); 
    reader.onload = e => { if(type==='room') document.getElementById('garden-img').src=e.target.result; else document.getElementById('pPrev').innerHTML=`<img id="mainPImg" src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;">`; }; 
    reader.readAsDataURL(input.files[0]); 
    resize(input.files[0], 1000).then(data => { if(type==='room') { state.areas[state.activeIdx].img=data; save(); } else pendingPImg=data; }); 
}

function resize(f, m) { return new Promise(r => { const rd = new FileReader(); rd.onload = e => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'); let w=i.width, h=i.height; if(w>m){ h*=m/w; w=m; } c.width=w; c.height=h; c.getContext('2d').drawImage(i,0,0,w,h); r(c.toDataURL('image/jpeg', 0.85)); }; i.src = e.target.result; }; rd.readAsDataURL(f); }); }
function handleHFile(i) { resize(i.files[0], 1000).then(d => { pendingHImg = d; document.getElementById('hPrev').innerHTML = `<img src="${d}" style="width:100%;height:100%;object-fit:cover;">`; }); }

function enterFlow() { closeMod('pModal'); showV('garden'); flowActive = true; alert("Tap the grid cell to place your plant."); }
function showV(v) { if (v !== 'garden') { flowActive = false; } document.querySelectorAll('.view').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.id === 'nav-'+v)); render(); }

function openMod(id) { 
    if (id === 'settingsModal') {
        document.getElementById('gRows').value = state.areas[state.activeIdx].grid.rows;
        document.getElementById('gCols').value = state.areas[state.activeIdx].grid.cols;
        document.getElementById('backupStatus').textContent = "Last backup: " + (state.lastBackup || "Not saved");
    }
    document.getElementById(id).style.display='flex'; 
}

function closeMod(id) { document.getElementById(id).style.display='none'; }
function previewCover() { const imgEl = document.getElementById('mainPImg'); if(imgEl) previewImg(imgEl.src); }
function previewImg(src) { document.getElementById('fullImgSrc').src = src; openMod('fullImgMod'); }

function roomSwitch(v) { 
    if(v==='ADD'){ 
        const n=prompt("Room Name?"); 
        if(n){ state.areas.push({id:Date.now(), name:n, img:null, spots:[], grid:{active:false, rows:4, cols:3, tl:{x:10,y:10}, tr:{x:90,y:10}, bl:{x:10,y:90}, br:{x:90,y:90}}}); state.activeIdx=state.areas.length-1; save(); } else render();
    } else { state.activeIdx = parseInt(v); render(); } 
}

function applyGridChanges() { state.areas[state.activeIdx].grid.rows = Math.max(1, parseInt(document.getElementById('gRows').value)); state.areas[state.activeIdx].grid.cols = Math.max(1, parseInt(document.getElementById('gCols').value)); save(); }
function togGrid() { state.areas[state.activeIdx].grid.active = !state.areas[state.activeIdx].grid.active; render(); }
function startCal() { closeMod('settingsModal'); calActive = true; document.getElementById('cal-done-float').style.display='block'; render(); }
function stopCal() { calActive = false; document.getElementById('cal-done-float').style.display='none'; save(); }
function deleteHarvest() { if(confirm("Delete this log?")) { state.harvests = state.harvests.filter(x => x.id !== currentHarvestID); closeMod('hModal'); save(); } }
function removeFromGarden() { const p = state.plants.find(x => x.id === currentPlantID); if(p) p.notes += `\n[${getISODate()}] Removed from Space`; state.areas.forEach(a => { a.spots = a.spots.filter(s => s.pId !== currentPlantID); }); closeMod('pModal'); save(); }
function renameRoom() { const n = prompt("Rename to:", state.areas[state.activeIdx].name); if(n) { state.areas[state.activeIdx].name = n; save(); } }
function deleteRoom() { if(state.areas.length <= 1) return alert("Cannot delete the last room."); if(confirm("Delete room?")) { state.areas.splice(state.activeIdx, 1); state.activeIdx = 0; save(); } }

function exportData() {
    const data = JSON.stringify(state);
    const blob = new Blob([data], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `hubbe_backup_${getISODate()}.json`;
    a.click();
    state.lastBackup = new Date().toLocaleString();
    save();
}

function importData(input) {
    if(!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const imported = JSON.parse(e.target.result);
            if(imported.areas && imported.plants) {
                state = imported;
                save();
                alert("Restore successful!");
                location.reload();
            }
        } catch(err) { alert("Invalid backup file."); }
    };
    reader.readAsText(input.files[0]);
}

// --- NEW LIGHT METER FUNCTIONS ---

function startLightMeter() {
    openMod('lightModal');
    const video = document.getElementById('cameraFeed');
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => {
                cameraStream = stream;
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    processLightFrame();
                };
            })
            .catch(err => {
                document.getElementById('lightScore').innerText = "Camera Error";
                document.getElementById('lightDesc').innerText = "Could not access the camera.";
                console.error("Error accessing camera: ", err);
            });
    } else {
        document.getElementById('lightScore').innerText = "Not Supported";
        document.getElementById('lightDesc').innerText = "Your browser does not support camera access.";
    }
}

function processLightFrame() {
    const video = document.getElementById('cameraFeed');
    const canvas = document.getElementById('lightCanvas');
    
    if (!video.videoWidth) {
        lightLoopId = requestAnimationFrame(processLightFrame);
        return;
    }
    
    // Scale down massively for performance. We just need the average color.
    canvas.width = 64; 
    canvas.height = 64;
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const frameData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = frameData.data;
    
    let totalLuminance = 0;
    const pixelCount = data.length / 4;
    
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Luminance math Y = 0.299R + 0.587G + 0.114B
        const luminance = (0.299 * r) + (0.587 * g) + (0.114 * b);
        totalLuminance += luminance;
    }
    
    const avgLuminance = totalLuminance / pixelCount;
    const scoreEl = document.getElementById('lightScore');
    const descEl = document.getElementById('lightDesc');
    
    let displayScore = Math.round(avgLuminance);
    scoreEl.innerText = displayScore + " LUX (est)";
    
    if (avgLuminance > 160) {
        descEl.innerText = "‚òÄÔ∏è Full Sun (High)";
        descEl.style.color = "var(--gold)";
    } else if (avgLuminance > 80) {
        descEl.innerText = "‚õÖ Part Sun (Medium)";
        descEl.style.color = "var(--blue)";
    } else {
        descEl.innerText = "‚òÅÔ∏è Low Light (Low)";
        descEl.style.color = "var(--gray)";
    }
    
    lightLoopId = requestAnimationFrame(processLightFrame);
}

function stopLightMeter() {
    if (lightLoopId) {
        cancelAnimationFrame(lightLoopId);
        lightLoopId = null;
    }
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    closeMod('lightModal');
}

document.querySelectorAll('.anchor').forEach(a => {
    const mv = (e) => { if(!calActive) return; const t = e.touches ? e.touches[0] : e; const r = document.getElementById('garden-img').getBoundingClientRect();
        state.areas[state.activeIdx].grid[a.dataset.id].x = Math.max(0, Math.min(100, ((t.clientX - r.left)/r.width)*100));
        state.areas[state.activeIdx].grid[a.dataset.id].y = Math.max(0, Math.min(100, ((t.clientY - r.top)/r.height)*100));
        render();
    };
    a.onmousedown = () => { window.onmousemove = mv; window.onmouseup = () => window.onmousemove = null; };
    a.ontouchstart = (e) => { e.preventDefault(); window.ontouchmove = mv; window.ontouchend = () => window.ontouchmove = null; };
});

window.onresize = render;
</script>
</body>
</html>
